using client;
using Serilog;

Console.Title = "client";

var builder = WebApplication.CreateBuilder(args);

// Регистрация ResponseListenerService как фонового сервиса
builder.Services.AddHostedService<ResponseListenerService>();

// Настройка Serilog
Log.Logger = new LoggerConfiguration()
	.WriteTo.Console()
	.CreateLogger();

builder.Host.UseSerilog();

// Чтение порта для запуска client
string? port = builder.Configuration["Port"]
			   ?? args.FirstOrDefault(arg => arg.StartsWith("--port="))?.Split('=')[1];

if (string.IsNullOrEmpty(port))
{
	port = "5001"; // Порт по умолчанию
}

// Настройка адреса запуска
string url = $"http://localhost:{port}";
builder.WebHost.UseUrls(url);

// Логирование адреса запуска
Log.Information("Приложение client запускается на {Url}", url);

builder.Services.AddSingleton<IRabbitMqService, RabbitMqService>();

var app = builder.Build();

// Настройка маршрутов:
// Здесь я отправляю определенное сообщение, полученное из post запроса в очередь:
app.MapPost("/send-request", async (HttpRequest request, IRabbitMqService rabbitMqService) =>
{
	// Получение тела запроса:
	using var reader = new StreamReader(request.Body);
	var message = await reader.ReadToEndAsync();
	Log.Information("Запрос отправлен: {Message}", message);

	// Отправка сообщения
	rabbitMqService.PublishMessage("request_queue", message);

	// Ожидание ответа
	var responseMessage = await rabbitMqService.WaitForResponse("response_queue");
	if (responseMessage != null)
	{
		Log.Information($"Получен ответ: {responseMessage}");
		return Results.Ok(new { Message = responseMessage });
	}

	Log.Warning("Тайм-аут при ожидании ответа");
	return Results.StatusCode(504);
});

app.Run();
